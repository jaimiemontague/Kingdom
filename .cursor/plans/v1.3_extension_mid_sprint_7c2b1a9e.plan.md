## V1.3 Extension — Mid-sprint Plan (Build: v1.3.0)

### Summary

V1.3 is being **extended**. Current build is not yet worthy of a v1.3 ship. This plan adds targeted gameplay/AI + UI/audio + building-behavior upgrades while keeping determinism and QA gates green.

### Goals (must ship)

- **AI**: Heroes buy potions more often; heroes flee less aggressively, especially when they have potions available.
- **UI**:
- Pause/menu button label text alignment is consistent across all menu buttons.
- Audio has **three** sliders: **Master**, **Music** (ambient), **SFX**.
- Camera/screen **does not scroll while paused** (ESC menu open or paused state).
- **Buildings / hero behavior**:
- **Blacksmith**: player can research **weapon/armor upgrades** at the Blacksmith; after research, heroes can enter Blacksmith and **purchase upgrades** (counts as a “purchase” for Journey trigger).
- **Demolish**: demolish option exists **only for player-owned buildings** (not monster lairs / not neutral buildings).

### Explicit Non-goals (do not do in this extension)

- Fog-of-war boundary/edge softness rendering changes.
- Hiding/removing debug overlays or tip text.

### Constraints (locked)

- **Determinism**: no wall-clock time in sim logic; seeded RNG only.
- **Gates must remain PASS**:
- `python tools/qa_smoke.py --quick`
- `python tools/validate_assets.py --strict --check-attribution`
- Avoid perf regressions: no per-frame allocations in hot render loops; cache text surfaces appropriately.

### Implementation Workstreams

#### Workstream A — AI: potion buying + flee tuning (Owner: Agent 06, support: Agent 05)

**A1. Potion buying frequency**

- Increase likelihood of buying potions when:
- marketplace can sell potions and hero gold >= price
- hero has fewer than a target potion count (target varies by class or level)
- Avoid “always cap to max” behavior; keep it incremental (e.g., target 1–2 early game).

**A2. Flee behavior**

- Reduce premature fleeing thresholds:
- If hero has potions and is below a “use potion” threshold, prefer **use potion** before retreat.
- Increase “retreat” threshold hysteresis so heroes don’t bounce.

**Acceptance**

- In manual play: heroes frequently purchase potions after research, and do not flee immediately when they still have potions.
- No regressions in bounty pursuit / Journey trigger.

#### Workstream B — UI polish: consistent button label alignment (Owner: Agent 08)

- Ensure the ESC menu buttons (and any other shared button widgets) render text using a **single alignment policy** (centered baseline and consistent padding).
- Fix any per-button font/offset inconsistencies.

**Acceptance**

- All menu buttons show labels aligned identically (no vertical jitter between buttons).

#### Workstream C — Audio: 3 volume sliders (Owners: Agent 14 + Agent 08; support: Agent 03 if engine wiring needed)

**C1. Audio system API**

- Add separate volumes:
- master (0–1)
- music/ambient (0–1)
- sfx (0–1)
- Final effective volume:
- SFX: `master * sfx * per_sound_volume`
- Music: `master * music * ambient_base_volume`

**C2. Pause menu UI**

- Replace single slider with three sliders and persist values for runtime session.
- Confirm UI sounds remain audible rules (UI sounds not fog-gated).

**Acceptance**

- Sliders work independently: lowering music doesn’t mute SFX; lowering SFX doesn’t mute music; master scales both.

#### Workstream D — Pause correctness: no camera scroll while paused (Owner: Agent 03)

- Ensure camera movement inputs (WASD, edge scroll, mouse wheel) are **disabled** while paused / pause menu visible.
- Still allow UI interactions (mouse clicks) while paused.

**Acceptance**

- With ESC menu open: mouse wheel and edge scroll do not move the world camera.

#### Workstream E — Blacksmith research + purchases + Journey synergy (Owners: Agent 05 + Agent 06; UI: Agent 08; support: Agent 03 as needed)

**E1. Research at Blacksmith**

- Add Blacksmith research buttons for:
- Weapon upgrades
- Armor upgrades
- Research is kingdom-wide (uses existing global research unlock pattern).

**E2. Purchases**

- After research, heroes can purchase upgraded weapons/armor from Blacksmith.
- Must go through the existing purchase path so it updates `hero.last_purchase_ms` for Journey trigger.

**E3. AI routing**

- Update hero shopping intent to consider Blacksmith when upgrades available and affordable.

**Acceptance**

- Player can research at Blacksmith; after research heroes visibly visit and purchase upgrades.
- After upgrade purchase, Journey behavior can trigger (purchase tracking works).

#### Workstream F — Demolish gating (Owner: Agent 08; support: Agent 03)

- Demolish button shown only if selected building is player-owned.
- Must not appear for lairs or neutral buildings.

**Acceptance**

- Selecting lair: no demolish button.
- Selecting player building: demolish button available (except castle rules unchanged).

### QA / Evidence (Owner: Agent 11)

- Run gates:
- `python tools/qa_smoke.py --quick`
- `python tools/validate_assets.py --strict --check-attribution`
- Manual Windows checks:
- Potion behavior: heroes buy/use potions; flee less aggressively.
- Pause: no camera scroll while paused.
- Audio sliders: master/music/sfx act independently.
- Blacksmith: research + purchases occur; Journey triggers after purchase.
- Demolish: not shown on lairs.